<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
    <title>Plauderpiraten</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 20px;
        outline: 0;
        border: 0;
    }
    html, body {
        background: #fff url('stuff/pirates.jpg');
        font-family: sans-serif;
        padding: 20px 0 60px;
    }
    h1 {
        position: fixed;
        top: 0;
        width: 100%;
        text-align: center;
        line-height: 2em;
        background: #586;
        color: #fff;
        box-shadow: 1px 1px 1px #000;
    }
    .message {
        padding: 10px;
        margin: 10px;
        background: #fff;
        overflow: auto;
        outline: 1px solid #586;
    }
    #form {
        position: fixed;
        bottom: 0;
        width: 100%;
        background: #586;
        height: 60px;

    }
    #new, #submit {
        position: absolute;
        padding: 10px;
        top: 10px;
        height: 40px;
        display: block;
        -webkit-box-sizing: border-box; /* Safari/Chrome, other WebKit */
        -moz-box-sizing: border-box;    /* Firefox, other Gecko */
        box-sizing: border-box;         /* Opera/IE 8+ */
    }
    #new {
        left: 3%;
        width: 72%;
        box-shadow: 1px 1px 1px #000 inset;
    }
    #submit {
        width: 22%;
        right: 3%;
        background: #BF360C;
        color: #fff;
        cursor: pointer;
        box-shadow: 1px 1px 1px #000;
    }
    </style>
</head>
<body>
    <h1>Plauderpiraten</h1>
    <div id="wrapper"></div>
    <form id="form">
        <input id="new" placeholder="Yohoho! Schreib hier!" />
        <input id="submit" type="submit" value="Arrr!" />
    </form>
<script src="stuff/socketio.js"></script>
<script>
window.chat = (function(doc, sock){
    var _inputField, _messagesWrapper;

    function askName() {
        sock.emit('join', prompt('Arrr! Wer bist du?'));
        cleanUp();
    }
    function cleanUp() {
        while(_messagesWrapper.firstChild) {
            _messagesWrapper.removeChild(_messagesWrapper.firstChild);
        }
    }
    function insertMessage(message) {
        var el = doc.createElement('p');
        el.className = 'message';
        el.innerText = message;
        doc.getElementById('wrapper').appendChild(el);
        delete el;
        window.scrollTo(0, doc.body.scrollHeight);
    }
    function sendMessage(e) {
        e.preventDefault();
        sock.emit('messages', _inputField.value);
        _inputField.value = '';
    }
    function disconnected() {
        cleanUp();
        insertMessage('Lost connection to server :(');
    }
    function init () {
        _inputField = doc.getElementById('new');
        _messagesWrapper = doc.getElementById('wrapper');
        sock.on('connect', askName);
        sock.on('disconnect', disconnected);
        sock.on('messages', insertMessage);
        doc.getElementById('form').addEventListener("submit", sendMessage);
        _inputField.focus();
    }
    return {
        init: init
    };
}(
    window.document,
    io.connect(window.location && window.location.origin || window.document.location.origin)
));

window.addEventListener('load', function (e) {
    window.chat.init();
});
</script>
</body>
</html>